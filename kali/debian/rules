#!/usr/bin/make -f

export DEB_BUILD_MAINT_OPTIONS = hardening=+all

%:
	dh $@

override_dh_auto_configure:
	autoreconf -fi
	dh_auto_configure -- \
		--prefix=/usr \
		--sysconfdir=/etc \
		--localstatedir=/var \
		--with-pgsql

override_dh_auto_install:
	dh_auto_install
	# =================================================================
	# Install Alicorn Web UI
	# =================================================================
	mkdir -p debian/unicornscan/opt/unicornscan-alicorn/src
	mkdir -p debian/unicornscan/opt/unicornscan-alicorn/public
	mkdir -p debian/unicornscan/opt/unicornscan-alicorn/cli
	mkdir -p debian/unicornscan/opt/unicornscan-alicorn/sql
	mkdir -p debian/unicornscan/opt/unicornscan-alicorn/postgrest
	mkdir -p debian/unicornscan/opt/unicornscan-alicorn/geoip-api
	# Docker configuration
	cp alicorn/docker-compose.standalone.yml debian/unicornscan/opt/unicornscan-alicorn/docker-compose.yml
	cp alicorn/Dockerfile debian/unicornscan/opt/unicornscan-alicorn/
	cp alicorn/nginx.conf debian/unicornscan/opt/unicornscan-alicorn/
	# PostgREST custom build
	cp alicorn/postgrest/Dockerfile debian/unicornscan/opt/unicornscan-alicorn/postgrest/
	# Build configuration
	cp alicorn/package.json debian/unicornscan/opt/unicornscan-alicorn/
	cp alicorn/package-lock.json debian/unicornscan/opt/unicornscan-alicorn/
	cp alicorn/vite.config.ts debian/unicornscan/opt/unicornscan-alicorn/
	-cp alicorn/vitest.config.ts debian/unicornscan/opt/unicornscan-alicorn/
	cp alicorn/tsconfig.json debian/unicornscan/opt/unicornscan-alicorn/
	cp alicorn/tsconfig.app.json debian/unicornscan/opt/unicornscan-alicorn/
	cp alicorn/tsconfig.node.json debian/unicornscan/opt/unicornscan-alicorn/
	-cp alicorn/eslint.config.js debian/unicornscan/opt/unicornscan-alicorn/
	cp alicorn/index.html debian/unicornscan/opt/unicornscan-alicorn/
	# Source code
	cp -r alicorn/src/* debian/unicornscan/opt/unicornscan-alicorn/src/
	cp -r alicorn/public/* debian/unicornscan/opt/unicornscan-alicorn/public/
	# CLI / Setup wizard
	cp alicorn/cli/setup.ts debian/unicornscan/opt/unicornscan-alicorn/cli/
	# GeoIP API service
	cp alicorn/geoip-api/Dockerfile debian/unicornscan/opt/unicornscan-alicorn/geoip-api/
	cp alicorn/geoip-api/package.json debian/unicornscan/opt/unicornscan-alicorn/geoip-api/
	cp alicorn/geoip-api/server.js debian/unicornscan/opt/unicornscan-alicorn/geoip-api/
	# SQL schema
	cp src/output_modules/database/sql/pgsql_schema.sql debian/unicornscan/opt/unicornscan-alicorn/sql/
	# =================================================================
	# Install documentation
	# =================================================================
	mkdir -p debian/unicornscan/usr/share/doc/unicornscan
	cp docs/GETTING_STARTED.md debian/unicornscan/usr/share/doc/unicornscan/
	cp docs/GETTING_STARTED_ALICORN.md debian/unicornscan/usr/share/doc/unicornscan/
	# =================================================================
	# Install management scripts
	# =================================================================
	install -Dm755 debian/unicornscan-alicorn debian/unicornscan/usr/bin/unicornscan-alicorn
	install -Dm755 scripts/unicornscan-geoip-update debian/unicornscan/usr/bin/unicornscan-geoip-update
