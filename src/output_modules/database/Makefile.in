include ../../../Makefile.inc

HDRS=geoip_provider.h

DBTYPES=@DBTYPES@

G_LDPATH=-L$(BUILD_DIR)/src/unilib -L$(BUILD_DIR)/src/parse -L$(BUILD_DIR)/src/scan_progs
CFLAGS += -DMODULE=1 @PG_CPPFLAGS@

# GeoIP support (v6) - libmaxminddb (MaxMind, IPinfo) and IP2Location
GEOIP_OBJS=geoip.lo geoip_maxmind.lo geoip_ipinfo.lo geoip_ip2location.lo
GEOIP_LDFLAGS=@GEOIP_LIBS@

all: $(DBTYPES)

pgsql: pgsqldb.la

pgsqldb.la: pgsqldb.lo $(GEOIP_OBJS) $(HDRS)
	$(LIBTOOL) --mode=link $(CC) $(MODCLFLAGS) $(CFLAGS) @PG_CPPFLAGS@ -o pgsqldb.la pgsqldb.lo $(GEOIP_OBJS) $(G_LDPATH) @PG_LDFLAGS@ $(GEOIP_LDFLAGS) -lpq -lunilib

clean:
	dbtypes="$(DBTYPES)" && for g in $$dbtypes; do \
		$(LIBTOOL) --mode=clean rm -f $${g}db.la;\
		$(LIBTOOL) --mode=clean rm -f $${g}db.lo;\
	done
	$(LIBTOOL) --mode=clean rm -f geoip.la geoip.lo
	$(LIBTOOL) --mode=clean rm -f geoip_maxmind.la geoip_maxmind.lo
	$(LIBTOOL) --mode=clean rm -f geoip_ipinfo.la geoip_ipinfo.lo
	$(LIBTOOL) --mode=clean rm -f geoip_ip2location.la geoip_ip2location.lo

distclean: clean
	rm -f template.h

install: all
	mkdir -p $(DESTDIR)/$(MODDIR)
	dbtypes="$(DBTYPES)" && for g in $$dbtypes; do \
		$(LIBTOOL) --mode=install $(INSTALL_PROGRAM) -m 755 $${g}db.la $(DESTDIR)/$(MODDIR)/; \
		if test -f $(DESTDIR)/$(MODDIR)/$${g%%.la}db.so; then \
			$(CHCON) system_u:object_r:shlib_t $(DESTDIR)/$(MODDIR)/$${g%%.la}db.so; \
			$(CHCON) system_u:object_r:unicornscan_share_t $(DESTDIR)/$(MODDIR)/$${g%%.la}db.la; \
		fi \
	done
	$(LIBTOOL) --mode=finish $(DESTDIR)/$(MODDIR)

uninstall:
	for g in $(DBTYPES); do \
		$(LIBTOOL) --mode=uninstall rm -f $(DESTDIR)/$(MODDIR)/$${g}db.la; \
	done
